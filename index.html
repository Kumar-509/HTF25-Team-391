... (continued) 
      });
    }

    function jobCard(j){
      const bids = state.bids.filter(b=>b.jobId===j.id);
      const low = bids.length? Math.min(...bids.map(b=>b.amount)) : null;
      return `
        <div class="list-item">
          <div class="meta">
            <span class="pill">${j.category}</span>
            <span class="pill">${new Date(j.created).toLocaleDateString()}</span>
            <span class="pill">${j.status.toUpperCase()}</span>
          </div>
          <h4>${j.title}</h4>
          <div class="meta">
            <span class="price">Budget: $${j.budget}</span>
            <span class="muted">Bids: ${bids.length}${low? ` (low $${low})`:""}</span>
          </div>
          <p class="muted">${j.desc}</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn small" data-open="${j.id}">View</button>
          </div>
        </div>`;
    }

    function renderJobs(){
      const list = $('#jobs');
      list.innerHTML = filteredJobs().sort((a,b)=>b.created-a.created).map(jobCard).join('');
      $$('[data-open]').forEach(btn=>btn.onclick=()=>openJob(btn.getAttribute('data-open')));
    }

    function openJob(id){
      const j = state.jobs.find(x=>x.id===id);
      state.selectedJob = j;
      const bids = state.bids.filter(b=>b.jobId===id).sort((a,b)=>a.amount-b.amount);
      $('#job-detail').innerHTML = `
        <div class="stack">
          <div class="meta">
            <span class="pill">${j.category}</span>
            <span class="pill">${j.status.toUpperCase()}</span>
          </div>
          <h3>${j.title}</h3>
          <p>${j.desc}</p>
          <div class="meta">
            <span class="price">Budget $${j.budget}</span>
            <span class="muted">Owner: ${j.owner? j.owner.name : 'Unassigned'}</span>
          </div>
        </div>
        <h4 style="margin-top:10px">Bids</h4>
        <div class="list" id="bid-list">
          ${bids.map(b=>`<div class="list-item">
            <div class="meta">
              <span class="pill">${b.user.name}</span>
              <span class="pill">$${b.amount}</span>
              <span class="pill">${b.days} days</span>
            </div>
            <p class="muted">${b.message}</p>
          </div>`).join('') || '<span class="muted">No bids yet</span>'}
        </div>`;

      const isOwner = state.user && j.owner && j.owner.id===state.user.id;
      $('#bids-area').classList.toggle('hidden', !(state.user && !isOwner && j.status==='open'));

      const owner = $('#owner-actions');
      owner.innerHTML = '';
      owner.classList.add('hidden');
      if(isOwner){
        owner.classList.remove('hidden');
        const bidsFor = state.bids.filter(b=>b.jobId===j.id);
        owner.innerHTML = `
          <h4>Owner Actions</h4>
          <div class="list">
            ${bidsFor.map(b=>`<div class="list-item">
              <div class="meta">
                <span class="pill">${b.user.name}</span>
                <span class="pill">$${b.amount}</span>
                <span class="pill">${b.days} days</span>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn small" data-assign="${b.id}">Assign</button>
                <button class="btn small alt" data-decline="${b.id}">Decline</button>
              </div>
            </div>`).join('') || '<span class="muted">No bids submitted yet</span>'}
          </div>`;
        $$('[data-assign]').forEach(x=>x.onclick=()=>assignBid(x.getAttribute('data-assign')));
        $$('[data-decline]').forEach(x=>x.onclick=()=>declineBid(x.getAttribute('data-decline')));
      }
      setRoute('browse');
    }

    function assignBid(bidId){
      const b = state.bids.find(x=>x.id===bidId);
      const j = state.jobs.find(x=>x.id===b.jobId);
      j.status='assigned';
      j.assignedTo = b.user;
      saveAll();
      openJob(j.id);
      render();
    }
    function declineBid(bidId){
      state.bids = state.bids.filter(x=>x.id!==bidId);
      saveAll();
      openJob(state.selectedJob.id);
      render();
    }

    function renderLiveBids(){
      const el = $('#live-bids');
      const last5 = state.bids.slice(-5).reverse();
      el.innerHTML = last5.map(b=>`<div class="list-item">
        <div class="meta"><span class="pill">${b.user.name}</span> bid <span class="price">$${b.amount}</span> on <span class="pill">${(state.jobs.find(j=>j.id===b.jobId)||{}).title||'Job'}</span></div>
        <div class="muted">${b.message}</div>
      </div>`).join('') || '<span class="muted">No activity yet</span>';
    }

    function ensureAuth(routeIfNoAuth){
      if(!state.user){ setRoute(routeIfNoAuth); return false; }
      return true;
    }

    function postJob(){
      if(!ensureAuth('auth')) return;
      const title=$('#job-title').value.trim();
      const budget=+$('#job-budget').value;
      const category=$('#job-category').value;
      const desc=$('#job-desc').value.trim();
      if(!title||!budget||!desc){ $('#post-msg').textContent='Please fill all fields'; return; }
      const j={id:uid(), title, budget, category, desc, owner: state.user, status:'open', created:Date.now()};
      state.jobs.push(j); saveAll();
      $('#post-msg').textContent='Job published';
      $('#job-title').value=''; $('#job-budget').value=''; $('#job-desc').value='';
      renderJobs();
    }

    function placeBid(){
      if(!ensureAuth('auth')) return;
      const j = state.selectedJob; if(!j){ $('#bid-msg').textContent='Open a job first'; return; }
      const amount=+$('#bid-amount').value; const days=+$('#bid-days').value; const message=$('#bid-message').value.trim();
      if(!amount||!days||!message){ $('#bid-msg').textContent='Enter amount, timeline, message'; return; }
      const b={id:uid(), jobId:j.id, user: state.user, amount, days, message, created:Date.now()};
      state.bids.push(b); saveAll();
      $('#bid-msg').textContent='Bid submitted';
      $('#bid-amount').value=''; $('#bid-days').value=''; $('#bid-message').value='';
      openJob(j.id); renderLiveBids(); renderMy();
    }

    function login(){
      const email=$('#login-email').value.trim(); const pass=$('#login-pass').value.trim();
      if(!email||!pass){ $('#login-msg').textContent='Email and password required'; return; }
      let users = store.get('fh:users', []);
      let u = users.find(x=>x.email===email && x.pass===pass);
      if(!u){ $('#login-msg').textContent='Invalid credentials'; return; }
      state.user = {id: u.id, name: u.name, email: u.email}; saveAll();
      $('#login-msg').textContent='Welcome back'; navSync(); render();
    }

    function register(){
      const name=$('#reg-name').value.trim(); const email=$('#reg-email').value.trim(); const pass=$('#reg-pass').value.trim();
      if(!name||!email||!pass){ $('#reg-msg').textContent='All fields required'; return; }
      let users = store.get('fh:users', []);
      if(users.some(u=>u.email===email)){ $('#reg-msg').textContent='Email already used'; return; }
      const u={id:uid(), name, email, pass}; users.push(u); localStorage.setItem('fh:users', JSON.stringify(users));
      state.user = {id:u.id, name:u.name, email:u.email}; saveAll();
      $('#reg-msg').textContent='Account created'; navSync(); render();
    }

    function logout(){ state.user=null; saveAll(); navSync(); render(); }

    function renderMy(){
      const mine = state.jobs.filter(j=>j.owner && state.user && j.owner.id===state.user.id);
      $('#my-jobs').innerHTML = mine.map(j=>`<div class="list-item">
        <div class="meta"><span class="pill">${j.category}</span><span class="pill">${j.status}</span></div>
        <h4>${j.title}</h4>
        <div class="muted">Budget $${j.budget}</div>
        <button class="btn small" data-open="${j.id}">Open</button>
      </div>`).join('') || '<span class="muted">No jobs yet</span>';

      const myb = state.bids.filter(b=>state.user && b.user.id===state.user.id);
      $('#my-bids').innerHTML = myb.map(b=>`<div class="list-item">
        <div class="meta"><span class="pill">$${b.amount}</span><span class="pill">${b.days} days</span></div>
        <div class="muted">${(state.jobs.find(j=>j.id===b.jobId)||{}).title||'Job'}</div>
      </div>`).join('') || '<span class="muted">No bids yet</span>';
    }

    function render(){
      seedIfEmpty();
      navSync();
      // route visibility
      $('#browse-view').style.display = state.route==='browse'||state.route==='home' ? 'block' : 'none';
      $('#post-view').style.display = state.route==='post' ? 'block' : 'none';
      $('#auth-view').style.display = state.route==='auth' ? 'block' : 'none';
      $('#dashboard-view').style.display = state.route==='my' ? 'block' : 'none';
      renderJobs(); renderLiveBids(); if(state.user) renderMy();
    }

    // Nav events
    $$('[data-route]').forEach(a=>a.onclick=(e)=>{ e.preventDefault(); const r=a.getAttribute('data-route'); if(r==='home'){ state.route='home'; } else { setRoute(r); }});
    $('#btn-find').onclick=()=>{ setRoute('browse'); renderJobs(); };
    $('#btn-post').onclick=postJob;
    $('#btn-bid').onclick=placeBid;
    $('#do-login').onclick=login;
    $('#do-register').onclick=register;
    $('#btn-login').onclick=()=>setRoute('auth');
    $('#btn-register').onclick=()=>setRoute('auth');
    $('#btn-logout').onclick=logout;
    $$('.tab').forEach(t=>t.onclick=()=>{ $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); state.filter=t.getAttribute('data-filter'); renderJobs(); });

    render();
  </script>
</body>
</html>
